<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тренировка памяти — Слова и Числа</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #1a1a1a;
      color: #ff4444;
      font-family: Arial, sans-serif;
      overflow: hidden;
      min-height: 100vh;
    }
    .header {
      position: fixed;
      top: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(135deg, #333, #555);
      border-left: 3px solid #ff3333;
      border-bottom: 3px solid #ff3333;
      z-index: 1000;
    }
    .xp-bar {
      background: #444;
      height: 10px;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    .xp-progress {
      height: 100%;
      background: #00ff00;
      width: 0%;
      transition: width 0.3s;
    }
    /* Верхняя ветвь — тренировка слов (горизонтальный скроллинг) */
    #topBranch {
      position: fixed;
      top: 70px;
      left: 0;
      width: 100%;
      padding: 10px;
      background: #222;
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      z-index: 900;
    }
    .top-branch-node {
      flex: 0 0 auto;
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #444, #222);
      border: 3px solid #666;
      border-radius: 10px;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.2);
      transition: all 0.3s;
      opacity: 0.7;
      user-select: none;
    }
    .top-branch-node.unlocked {
      opacity: 1;
      border-color: #ff3333;
    }
    .top-branch-node.completed {
      background: #00ff00 !important;
      border-color: #00ff00 !important;
      cursor: default;
      animation: completed 1s infinite;
    }
    .top-branch-node.locked {
      cursor: not-allowed;
      opacity: 0.3;
    }
    .top-branch-node:hover:not(.locked):not(.completed) {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
    }
    /* Нижняя ветвь — тренировка чисел (вертикальное дерево) */
    #numberTree {
      position: absolute;
      top: 180px; /* Отступ с учётом header и верхней ветви */
      left: 0;
      width: 100%;
      height: 20000px;
      overflow: auto;
      touch-action: none;
    }
    .skill-node {
      position: absolute;
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #444, #222);
      border: 3px solid #666;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
      transition: all 0.3s;
      opacity: 0.7;
      user-select: none;
    }
    .skill-node.unlocked {
      opacity: 1;
      border-color: #ff3333;
    }
    .skill-node.completed {
      background: #00ff00 !important;
      border-color: #00ff00 !important;
      cursor: default;
      animation: completed 1s infinite;
    }
    .skill-node.locked {
      cursor: not-allowed;
      opacity: 0.3;
    }
    .skill-node:hover:not(.locked):not(.completed) {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
    }
    .connection-line {
      position: absolute;
      background: linear-gradient(90deg, #ff3333, #ff9933);
      height: 2px;
      transform-origin: 0 50%;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
    }
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 2px solid #ff3333;
    }
    .modal-buttons {
      margin-top: 15px;
    }
    .modal-buttons button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
    }
    .word-display {
      font-size: 2.5em;
      color: #00ffee;
      margin: 20px 0;
    }
    #timer {
      font-size: 1.5em;
      color: #ffcc00;
      margin: 15px 0;
    }
    .hint {
      color: #aaa;
      margin-bottom: 15px;
      font-style: italic;
    }
    @keyframes completed {
      0% { box-shadow: 0 0 10px #00ff00; }
      50% { box-shadow: 0 0 25px #00ff00; }
      100% { box-shadow: 0 0 10px #00ff00; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="xp-display">Опыт: <span id="xpCounter">0</span></div>
    <div class="xp-bar">
      <div class="xp-progress" id="xpProgress"></div>
    </div>
  </div>

  <!-- Верхняя ветвь уровней (слова) -->
  <div id="topBranch"></div>

  <!-- Нижняя ветвь уровней (числа) -->
  <div id="numberTree"></div>

  <!-- Модальное окно тренировки -->
  <div id="trainingModal" class="modal">
    <div class="modal-content">
      <div id="stage1">
        <div class="hint" id="hint"></div>
        <div class="word-display" id="wordDisplay"></div>
        <div id="timer">4</div>
        <div class="modal-buttons">
          <button onclick="nextStage()">Далее</button>
          <button onclick="closeModal()">Закрыть</button>
        </div>
      </div>
      <div id="stage2" style="display: none;">
        <h2>Введите значение:</h2>
        <input type="text" id="wordInput">
        <div class="modal-buttons">
          <button onclick="checkAnswer()">Проверить</button>
          <button onclick="closeModal()">Закрыть</button>
        </div>
        <div id="feedback" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <script>
    let currentValue = "";
    let timerInterval = null;
    let activeNode = null;
    let xp = 0;
    // Текущий уровень для каждой ветви
    let currentWordLevel = 1;
    let currentNumberLevel = 1;
    
    // Контейнеры
    const topBranch = document.getElementById("topBranch");
    const numberTree = document.getElementById("numberTree");

    // Сохранение/загрузка прогресса
    function saveProgress() {
      const data = {
        xp: xp,
        currentWordLevel: currentWordLevel,
        currentNumberLevel: currentNumberLevel
      };
      localStorage.setItem("memoryTrainerData", JSON.stringify(data));
    }
    function loadProgress() {
      const data = localStorage.getItem("memoryTrainerData");
      if (data) {
        try {
          const parsed = JSON.parse(data);
          xp = parsed.xp || 0;
          currentWordLevel = parsed.currentWordLevel || 1;
          currentNumberLevel = parsed.currentNumberLevel || 1;
          document.getElementById("xpCounter").textContent = xp;
          document.getElementById("xpProgress").style.width = (xp % 100) + "%";
        } catch (e) {
          console.error("Ошибка загрузки данных:", e);
          xp = 0;
          currentWordLevel = 1;
          currentNumberLevel = 1;
        }
      }
    }
    
    // Генерация случайного слова: первая буква заглавная, длина = 3 + (уровень - 1)
    function generateRandomWord(length) {
      const letters = "abcdefghijklmnopqrstuvwxyz";
      let word = "";
      for (let i = 0; i < length; i++) {
        word += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      return word.charAt(0).toUpperCase() + word.slice(1);
    }
    // Генерация случайного числа: число с заданным количеством цифр
    function generateRandomNumber(digits) {
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Создание узла уровня для верхней ветви (слова)
    function createWordLevelNode(level) {
      const node = document.createElement("div");
      node.classList.add("top-branch-node");
      node.dataset.type = "word";
      node.dataset.level = level;
      const speed = 1 + 0.2 * (level - 1);
      const xpReward = 10 + 5 * (level - 1);
      const wordLength = 3 + (level - 1);
      node.dataset.speed = speed;
      node.dataset.xp = xpReward;
      node.dataset.length = wordLength;
      node.innerHTML = `Уровень ${level}<br>Speed x${speed.toFixed(1)}`;
      
      if (level < currentWordLevel) {
        node.classList.add("completed");
      } else if (level === currentWordLevel) {
        node.classList.add("unlocked");
      } else {
        node.classList.add("locked");
      }
      
      node.onclick = function() {
        startTraining(node);
      };
      
      topBranch.appendChild(node);
      return node;
    }
    
    // Создание узла уровня для нижней ветви (числа)
    function createNumberLevelNode(level) {
      const node = document.createElement("div");
      node.classList.add("skill-node");
      node.dataset.type = "number";
      node.dataset.level = level;
      const speed = 1 + 0.2 * (level - 1);
      const xpReward = 10 + 5 * (level - 1);
      const digits = 4 + Math.floor((level - 1) / 2);
      node.dataset.speed = speed;
      node.dataset.xp = xpReward;
      node.dataset.digits = digits;
      
      // Размещение: вертикально с чередованием позиций
      const topPos = (level - 1) * 200;
      const leftPos = (level % 2 === 0) ? "25%" : "75%";
      node.style.top = topPos + "px";
      node.style.left = leftPos;
      
      node.innerHTML = `Уровень ${level}<br>Speed x${speed.toFixed(1)}`;
      
      if (level < currentNumberLevel) {
        node.classList.add("completed");
      } else if (level === currentNumberLevel) {
        node.classList.add("unlocked");
      } else {
        node.classList.add("locked");
      }
      
      node.onclick = function() {
        startTraining(node);
      };
      
      numberTree.appendChild(node);
      
      if (level > 1) {
        const prevNode = document.querySelector(`.skill-node[data-level="${level - 1}"]`);
        if (prevNode) {
          createConnectionLine(prevNode, node, numberTree);
        }
      }
      return node;
    }
    
    // Создание линии-соединителя (для нижней ветви)
    function createConnectionLine(node1, node2, container) {
      const line = document.createElement("div");
      line.classList.add("connection-line");
      container.appendChild(line);
      
      const rect1 = node1.getBoundingClientRect();
      const rect2 = node2.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      const x1 = rect1.left + rect1.width / 2 - containerRect.left;
      const y1 = rect1.top + rect1.height / 2 - containerRect.top;
      const x2 = rect2.left + rect2.width / 2 - containerRect.left;
      const y2 = rect2.top + rect2.height / 2 - containerRect.top;
      
      const deltaX = x2 - x1;
      const deltaY = y2 - y1;
      const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
      
      line.style.width = distance + "px";
      line.style.top = y1 + "px";
      line.style.left = x1 + "px";
      line.style.transform = `rotate(${angle}deg)`;
    }
    
    function updateAllConnections() {
      numberTree.querySelectorAll(".connection-line").forEach(line => line.remove());
      const nodes = numberTree.querySelectorAll(".skill-node");
      nodes.forEach(node => {
        const level = parseInt(node.dataset.level);
        if (level > 1) {
          const prevNode = numberTree.querySelector(`.skill-node[data-level="${level - 1}"]`);
          if (prevNode) createConnectionLine(prevNode, node, numberTree);
        }
      });
    }
    
    // Перетаскивание нижней ветви (чисел)
    let isDragging = false, dragStartX = 0, dragStartY = 0;
    let treePosition = { x: 0, y: 0 };
    numberTree.addEventListener("mousedown", (e) => {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      numberTree.style.transition = "none";
    });
    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      treePosition.x += deltaX;
      treePosition.y += deltaY;
      numberTree.style.transform = `translate(${treePosition.x}px, ${treePosition.y}px)`;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
    });
    window.addEventListener("mouseup", () => {
      isDragging = false;
      numberTree.style.transition = "transform 0.3s";
    });
    // (Добавьте аналогичные touch-события при необходимости)
    
    // Модальное окно – функции тренировки
    function closeModal() {
      clearInterval(timerInterval);
      document.getElementById("trainingModal").style.display = "none";
    }
    function nextStage() {
      clearInterval(timerInterval);
      document.getElementById("stage1").style.display = "none";
      document.getElementById("stage2").style.display = "block";
    }
    // При клике по узлу тренировки определяется тип (word/number)
    function startTraining(node) {
      if (node.classList.contains("locked") || node.classList.contains("completed")) return;
      activeNode = node;
      const type = node.dataset.type; // "word" или "number"
      const speed = parseFloat(node.dataset.speed) || 1;
      const level = parseInt(node.dataset.level);
      const xpReward = parseInt(node.dataset.xp);
      const time = 4 / speed;
      
      if (type === "word") {
        const wordLength = parseInt(node.dataset.length);
        currentValue = generateRandomWord(wordLength);
        document.getElementById("hint").textContent = "Запомните слово:";
      } else {
        const digits = parseInt(node.dataset.digits);
        currentValue = generateRandomNumber(digits);
        document.getElementById("hint").textContent = "Запомните число:";
      }
      
      document.getElementById("wordDisplay").textContent = currentValue;
      document.getElementById("timer").textContent = time.toFixed(1);
      document.getElementById("stage1").style.display = "block";
      document.getElementById("stage2").style.display = "none";
      document.getElementById("wordInput").value = "";
      document.getElementById("feedback").textContent = "";
      document.getElementById("trainingModal").style.display = "block";
      
      let timeLeft = time;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft -= 0.1;
        document.getElementById("timer").textContent = timeLeft.toFixed(1);
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          nextStage();
        }
      }, 100);
    }
    function checkAnswer() {
      const userAnswer = document.getElementById("wordInput").value;
      const feedback = document.getElementById("feedback");
      if (userAnswer.trim().toLowerCase() === currentValue.toLowerCase()) {
        feedback.textContent = "Правильно!";
        feedback.style.color = "#00ff00";
        activeNode.classList.add("completed");
        updateXP(parseInt(activeNode.dataset.xp));
        const type = activeNode.dataset.type;
        const level = parseInt(activeNode.dataset.level);
        if (type === "word") {
          const nextLevel = level + 1;
          const nextNode = document.querySelector(`.top-branch-node[data-level="${nextLevel}"]`);
          if (nextNode) {
            nextNode.classList.remove("locked");
            nextNode.classList.add("unlocked");
          } else {
            currentWordLevel = nextLevel;
            createWordLevelNode(nextLevel);
          }
        } else {
          const nextLevel = level + 1;
          const nextNode = document.querySelector(`.skill-node[data-level="${nextLevel}"]`);
          if (nextNode) {
            nextNode.classList.remove("locked");
            nextNode.classList.add("unlocked");
          } else {
            currentNumberLevel = nextLevel;
            createNumberLevelNode(nextLevel);
          }
          updateAllConnections();
        }
        saveProgress();
        setTimeout(closeModal, 1000);
      } else {
        feedback.textContent = "Неправильно!";
        feedback.style.color = "#ff0000";
      }
    }
    function updateXP(amount) {
      xp += amount;
      document.getElementById("xpCounter").textContent = xp;
      document.getElementById("xpProgress").style.width = (xp % 100) + "%";
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      loadProgress();
      // Инициализация верхней ветви (слова)
      for (let level = 1; level < currentWordLevel; level++) {
        createWordLevelNode(level);
        const node = document.querySelector(`.top-branch-node[data-level="${level}"]`);
        if (node) node.classList.add("completed");
      }
      createWordLevelNode(currentWordLevel);
      
      // Инициализация нижней ветви (числа)
      for (let level = 1; level < currentNumberLevel; level++) {
        createNumberLevelNode(level);
        const node = document.querySelector(`.skill-node[data-level="${level}"]`);
        if (node) node.classList.add("completed");
      }
      createNumberLevelNode(currentNumberLevel);
      updateAllConnections();
    });
  </script>
</body>
</html>
